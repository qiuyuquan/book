## node 异步编程
  node异步的三大特点
    1. 单线程
    2. 非阻塞I/O
    3. 事件驱动
  
#### 单线程
  > 多线程：将cpu分成几个线程，每个线程同步运行  
  > 单线程：负责解析和执行js代码线程的只有一个，每个计算都独占cpu，顺序执行，每次只执行一个任务。

  ![多线程](https://image-static.segmentfault.com/346/571/3465718080-5afeaadd84c6b_articlex)

  ![单线程图](https://image-static.segmentfault.com/198/599/1985996206-5afeab422c868_articlex)

  只有js执行是单线程，I/O显然是其它线程。js执行线程是单线程，把需要做的I/O交给libuv，自己马上返回做别的事情，然后libuv在指定的时刻回调就行了。

#### 非阻塞I/O  
  I/O是什么
  > I/O（英语：Input/Output），即输入/输出，通常指数据在内部存储器和外部存储器或其他周边设备之间的输入和输出，比如文件读写，网络请求。

  异步I/O的大致流程
  1. 发起I/O调用
    * 用户通过 Javascript 代码调用 Node 核心模块，将参数和回调函数传入到核心模块；
    * Node 核心模块会将传入的参数和回调函数封装成一个请求对象；
    * 将这个请求对象推入到 I/O 线程池等待执行；
    * Javascript 发起的异步调用结束，Javascript 线程继续执行后续操作；
  

  2. 执行回调
  I/O 操作完成后，会取出之前封装在请求对象中的回调函数，进入事件驱动

  ![](https://img.html.cn/upload/image/512/429/494/1567843589518461.jpg)

#### 事件驱动
  何为事件驱动，事件驱动是发布-订阅（观察者）的一种模式，通过事件或状态的变化来进行应用程序的流程控制。

  当IO线程执行完毕后，将事件压入事件队列中，然后node通过循环来检测队列中的事件状态变化，如果检测到有状态变化的事件，就执行该事件对应的处理代码，这就是所谓的事件驱动。

## 事件队列与事件循环
  > 事件队列：事件队列是一个先进先出的队列，当一个事件状态发生变化时，就将一个消息压入队列中。
  > 事件循环：事件循环是指主线程循环从事件队列中取出任务、执行的过程。

#### 事件循环的过程
  1. 每个Node.js进程只有一个主线程在执行程序代码，形成一个执行栈（execution context stack)。

  2. 主线程之外，还维护了一个"事件队列"（Event queue）。当用户的网络请求或者其它的异步操作到来时，node都会把它放到Event Queue之中，此时并不会立即执行它，代码也不会被阻塞，继续往下走，直到主线程代码执行完毕。

  3. 主线程代码执行完毕完成后，然后通过Event Loop，也就是事件循环机制，开始到Event Queue的开头取出第一个事件，从线程池中分配一个线程去执行这个事件，接下来继续取出第二个事件，再从线程池中分配一个线程去执行，然后第三个，第四个。主线程不断的检查事件队列中是否有未执行的事件，直到事件队列中所有事件都执行完了，此后每当有新的事件加入到事件队列中，都会通知主线程按顺序取出交EventLoop处理。当有事件执行完毕后，会通知主线程，主线程执行回调，线程归还给线程池。

  4. 主线程不断重复上面的第三步。

#### NodeJS的事件循环模型一般要注意下面几点
  1. 因为是单线程的，所以当顺序执行js文件中的代码的时候，事件循环是被暂停的
  2. 当JS文件执行完以后，事件循环开始运行，并从事件队列中取出消息，开始执行回调函数
  3. 因为是单线程的，所以当回调函数被执行的时候，事件循环是被暂停的
  4. 当涉及到I/O的时候，nodejs会开一个独立的线程来进行异步I/O操作，操作结果以后将消息压入事件队列

  ![](https://image-static.segmentfault.com/325/916/3259161542-575018ce29d44_articlex)

#### 参考文章
  [nodejs 异步I/O和事件驱动](https://segmentfault.com/a/1190000005173218)  
  [JavaScript：彻底理解同步、异步和事件循环(Event Loop)](https://segmentfault.com/a/1190000004322358)



